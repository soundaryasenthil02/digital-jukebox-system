{% extends 'music/base.html' %}

{% block title %}Analytics Dashboard - Digital Jukebox{% endblock %}

{% block content %}
<style>
    .chart-container {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-title {
        color: #667eea;
        font-size: 1.3em;
        margin-bottom: 20px;
        text-align: center;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        text-align: center;
    }
    
    .stat-box h3 {
        font-size: 2.5em;
        margin-bottom: 10px;
    }
    
    .stat-box p {
        opacity: 0.9;
        font-size: 1em;
    }
    
    canvas {
        max-height: 400px;
    }
</style>

<h2 style="color: #667eea; margin-bottom: 30px; text-align: center;">ðŸ“Š Analytics Dashboard</h2>

<!-- Overall Statistics -->
<div class="stats-grid">
    <div class="stat-box">
        <h3>{{ total_songs }}</h3>
        <p>Total Songs</p>
    </div>
    <div class="stat-box">
        <h3>{{ total_artists }}</h3>
        <p>Artists</p>
    </div>
    <div class="stat-box">
        <h3>{{ total_albums }}</h3>
        <p>Albums</p>
    </div>
    <div class="stat-box">
        <h3>{{ total_plays }}</h3>
        <p>Total Plays</p>
    </div>
    <div class="stat-box">
        <h3>{{ total_users }}</h3>
        <p>Users</p>
    </div>
    <div class="stat-box">
        <h3>{{ total_playlists }}</h3>
        <p>Playlists</p>
    </div>
</div>

<!-- Charts Grid -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px;">
    
    <!-- Top Songs Chart -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸŽµ Top 10 Most Played Songs</h3>
        <canvas id="topSongsChart"></canvas>
    </div>
    
    <!-- Popular Artists Chart -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸŽ¤ Most Popular Artists</h3>
        <canvas id="popularArtistsChart"></canvas>
    </div>
    
    <!-- Genre Distribution Chart -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸŽ¨ Genre Distribution</h3>
        <canvas id="genreChart"></canvas>
    </div>
    
    <!-- Daily Plays Chart -->
    <div class="chart-container">
        <h3 class="chart-title">ðŸ“ˆ Play History (Last 30 Days)</h3>
        <canvas id="dailyPlaysChart"></canvas>
    </div>
</div>

<!-- Most Active Users -->
<div class="chart-container" style="margin-top: 30px;">
    <h3 class="chart-title">ðŸ‘¥ Most Active Users</h3>
    <div style="display: grid; gap: 15px;">
        {% for user in active_users %}
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h4 style="color: #333; margin-bottom: 5px;">{{ user.first_name }} {{ user.last_name }}</h4>
                <p style="color: #666; font-size: 0.9em;">@{{ user.username }}</p>
            </div>
            <div style="background: #667eea; color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold;">
                {{ user.play_count }} plays
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
// Chart.js Configuration
const chartColors = {
    primary: '#667eea',
    secondary: '#764ba2',
    success: '#28a745',
    danger: '#dc3545',
    warning: '#ffc107',
    info: '#17a2b8',
};

const gradientColors = [
    'rgba(102, 126, 234, 0.8)',
    'rgba(118, 75, 162, 0.8)',
    'rgba(40, 167, 69, 0.8)',
    'rgba(220, 53, 69, 0.8)',
    'rgba(255, 193, 7, 0.8)',
    'rgba(23, 162, 184, 0.8)',
    'rgba(255, 99, 132, 0.8)',
    'rgba(54, 162, 235, 0.8)',
    'rgba(255, 206, 86, 0.8)',
    'rgba(75, 192, 192, 0.8)',
];

// Top Songs Bar Chart
const topSongsData = {
    labels: [
        {% for song in top_songs %}
        "{{ song.title|truncatechars:20 }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Play Count',
        data: [
            {% for song in top_songs %}
            {{ song.play_count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: gradientColors[0],
        borderColor: chartColors.primary,
        borderWidth: 2,
        borderRadius: 5,
    }]
};

const topSongsChart = new Chart(document.getElementById('topSongsChart'), {
    type: 'bar',
    data: topSongsData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
                titleColor: '#fff',
                bodyColor: '#fff',
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Popular Artists Horizontal Bar Chart
const popularArtistsData = {
    labels: [
        {% for artist in popular_artists %}
        "{{ artist.artist_name }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Total Plays',
        data: [
            {% for artist in popular_artists %}
            {{ artist.total_plays }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: gradientColors[1],
        borderColor: chartColors.secondary,
        borderWidth: 2,
        borderRadius: 5,
    }]
};

const popularArtistsChart = new Chart(document.getElementById('popularArtistsChart'), {
    type: 'bar',
    data: popularArtistsData,
    options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Genre Distribution Pie Chart
const genreData = {
    labels: [
        {% for genre in genre_stats %}
        "{{ genre.genre }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        data: [
            {% for genre in genre_stats %}
            {{ genre.count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: gradientColors,
        borderColor: '#fff',
        borderWidth: 2,
    }]
};

const genreChart = new Chart(document.getElementById('genreChart'), {
    type: 'doughnut',
    data: genreData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
            }
        }
    }
});

// Daily Plays Line Chart
const dailyPlaysData = {
    labels: [
        {% for play in daily_plays %}
        "{{ play.day }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    datasets: [{
        label: 'Plays',
        data: [
            {% for play in daily_plays %}
            {{ play.count }}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        backgroundColor: 'rgba(102, 126, 234, 0.2)',
        borderColor: chartColors.primary,
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointBackgroundColor: chartColors.primary,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverRadius: 7,
    }]
};

const dailyPlaysChart = new Chart(document.getElementById('dailyPlaysChart'), {
    type: 'line',
    data: dailyPlaysData,
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.8)',
                padding: 12,
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>

{% endblock %}